<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>共青团团员信息化平台数据库</title>
    <!-- Force latest IE rendering engine or ChromeFrame if installed -->
    <!--[if IE]>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <![endif]-->
    <link rel="stylesheet" href="app/login/css/style.css"/>
    <link rel="stylesheet" href="vendor/artDialog/artDialog.css"/>
    <script type="text/javascript" src="vendor/jquery-v1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="vendor/jquery-v1.8.3/jquery.md5.js"></script>
    <script type="text/javascript" src="static/ycrl/javascript/angular-all.js"></script>
    <script type="text/javascript" src="static/ycrl/javascript/angular-strap-all.js"></script>
    <script type="text/javascript" src="vendor/angular-v1.2.9/angular-cookies.min.js"></script>
    <script type="text/javascript" src="app/login/js/cloud.js"></script>
    <script>
        $(function () {
            $('.loginbox').css({'position': 'absolute', 'left': ($(window).width() - 692) / 2});
            $(window).resize(function () {
                $('.loginbox').css({'position': 'absolute', 'left': ($(window).width() - 692) / 2});
            });
        });
    </script>
</head>
<body id="eccrm.login" ng-app="eccrm.login" ng-controller="Ctrl"
      style="background: #1c77ac url(app/login/images/light.png) no-repeat center top;overflow:hidden;">
<div id="mainBody">
    <div id="cloud1" class="cloud"></div>
    <div id="cloud2" class="cloud"></div>
</div>

<div class="logintop">
    <span>欢迎登录后台管理界面平台</span>
    <ul>
        <li><a href="#">关于</a></li>
    </ul>
</div>

<div class="loginbody">
    <span class="systemlogo"></span>

    <div class="loginbox">

        <ul>
            <li><input type="text" class="loginuser" ng-model="user.username"/></li>
            <li><input type="password" class="loginpwd" ng-model="user.password"/></li>
            <li>
                <button class="loginbtn" ng-click="login();">登录</button>
                <label><a href="#">管理员注册</a></label>
                <label><a href="#">流动团员注册</a></label>
            </li>
        </ul>


    </div>

</div>


<script type="text/javascript">
    (function (angular, $) {
        var app = angular.module('eccrm.login', [
            'eccrm.angular',
            'ngCookies'
        ]);
        app.controller('Ctrl', ['$scope', '$http', '$cookies', function ($scope, $http, $cookies) {

            var username = $cookies['user.username'] || null;
            var code = $cookies['user.code'] || null;
            if (username) {
                $scope.remember = true;
            }
            $scope.user = {
                code: '上海优创',
                username: username
            };
            $scope.register = function () {
                artDialog({
                    title: '注册',
                    padding: '10px 10px',
                    margin: 0,
                    lock: true,
                    background: '#000', // 背景色
                    opacity: 0.5,	// 透明度
                    height: 400,
                    width: 800,
                    content: '<iframe src="base/user/register" style="border:none;padding: 0;margin:0;width: 700px;height: 400px;"></iframe>'
                });

            };
            $scope.login = function () {
                if (!$scope.user.username) {
                    alert('请输入用户名!');
                    $('#username').focus();
                    return;
                }
                if (!$scope.user.password) {
                    alert('请输入密码!');
                    $('#username').focus();
                    return;
                }
                var focused = $(':focus:eq(0)');
                $scope.error = '';
                $scope.busy = true;
                var dialog = window.art.artDialog({
                    title: '登录  ',
                    drag: false,
                    resize: false
                });
                $http.post('login', {
                    code: $scope.user.code,
                    username: $scope.user.username,
                    password: $.md5($scope.user.password)
                }).success(function (data) {
                            dialog.close();
                            $scope.busy = false;
                            data = data || {};
                            if (data['success']) {//登录成功
                                //保存登录的信息
                                if ($scope.remember) {
                                    $cookies['user.username'] = $scope['user'].username;
                                } else {
                                    delete $cookies['user.username'];
                                }
                                window.location.href = 'main';
                            } else if (data['inactive']) {//未激活
                                window.location.href = 'main';
                            } else {//登录失败
                                alert(data['error'] || data['fail']);
                            }
                            focused && focused.focus();
                        }
                ).error(function (data) {
                    console.dir(data);
                });
            };

            //绑定回车键
            angular.element(document).on('keyup', function (e) {
                var key = e.keyCode || e.which;
                if (key == 13) $scope.login();
            });

        }]);
    })(angular, jQuery);

    //解决session失效后登录页面不是顶层窗口的问题
    if (window.top != window) {
        window.top.location.href = window.location.href;
    }
</script>
</body>
</html>
